name: Sync with Upstream

on:
  schedule:
    # æ¯å¤©ä¸­åˆ12ç‚¹UTCï¼ˆåŒ—äº¬æ—¶é—´æ™šä¸Š8ç‚¹ï¼‰è¿è¡Œ
    # å¦‚æžœä½ æƒ³è¦åŒ—äº¬æ—¶é—´ä¸­åˆ12ç‚¹ï¼Œåº”è¯¥æ˜¯UTCæ—¶é—´æ—©ä¸Š4ç‚¹ï¼ˆ12-8=4ï¼‰
    - cron: '0 4 * * *'  # åŒ—äº¬æ—¶é—´ä¸­åˆ12ç‚¹
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout current repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/TrialLord/augment-trial-reset.git || true
          git remote -v

      - name: Fetch upstream changes
        run: |
          git fetch upstream

      - name: Check for updates
        id: check_updates
        run: |
          # æ£€æŸ¥ä¸Šæ¸¸æ˜¯å¦æœ‰æ–°çš„æäº¤
          LOCAL_COMMIT=$(git rev-parse HEAD)
          UPSTREAM_COMMIT=$(git rev-parse upstream/master)
          
          echo "Local commit: $LOCAL_COMMIT"
          echo "Upstream commit: $UPSTREAM_COMMIT"
          
          if [ "$LOCAL_COMMIT" != "$UPSTREAM_COMMIT" ]; then
            echo "updates_available=true" >> $GITHUB_OUTPUT
            echo "Updates available from upstream"
          else
            echo "updates_available=false" >> $GITHUB_OUTPUT
            echo "Repository is up to date"
          fi

      - name: Merge upstream changes
        if: steps.check_updates.outputs.updates_available == 'true'
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰æœ¬åœ°æ›´æ”¹
          if ! git diff-index --quiet HEAD --; then
            echo "âš ï¸ æ£€æµ‹åˆ°æœ¬åœ°æ›´æ”¹ï¼Œåˆ›å»ºå¤‡ä»½åˆ†æ”¯"
            git branch backup-before-sync-$(date +%Y%m%d-%H%M%S)
          fi
          
          # å°è¯•å¿«è¿›åˆå¹¶
          if git merge upstream/master --ff-only; then
            echo "âœ… å¿«è¿›åˆå¹¶æˆåŠŸ"
          else
            echo "âš ï¸ æ— æ³•å¿«è¿›åˆå¹¶ï¼Œå°è¯•å¸¸è§„åˆå¹¶"
            if git merge upstream/master -m "ðŸ¤– Auto-sync with upstream repository $(date)"; then
              echo "âœ… åˆå¹¶æˆåŠŸ"
            else
              echo "âŒ åˆå¹¶å¤±è´¥ï¼Œå­˜åœ¨å†²çª"
              echo "::error::åˆå¹¶å†²çªéœ€è¦æ‰‹åŠ¨è§£å†³"
              exit 1
            fi
          fi

      - name: Push changes
        if: steps.check_updates.outputs.updates_available == 'true'
        run: |
          git push origin master

      - name: Create summary
        run: |
          if [ "${{ steps.check_updates.outputs.updates_available }}" == "true" ]; then
            echo "âœ… Repository synchronized with upstream successfully" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“Š Changes merged from https://github.com/TrialLord/augment-trial-reset.git" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ Repository is already up to date with upstream" >> $GITHUB_STEP_SUMMARY
          fi 